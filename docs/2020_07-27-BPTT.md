## Back propagation through time



> Notation
>
> - $\textbf h^{(t)} = tanh(\textbf a^{(t)})$
> - $\textbf a^{(t)} = \textbf W \textbf h^{(t - 1)} + \textbf U \textbf x^{(t)} + \textbf b$
> - $\textbf o^{(t)} = \textbf V \textbf h^{(t)} + \textbf c$
> - $\textbf y'^{(t)} = softmax(\textbf o^{(t)})$
> - $\textbf y^{(t)} =$  label vector
> - $J^{(t)}_{mse}(\boldsymbol{\theta}) = \sum_j {(y^{(t)}_j - y'^{(t)}_j)}^2$
> - $J^{(t)}_{cse}(\boldsymbol{\theta}) = -y^{(t)}_y log \ y'^{(t)}_y$
> - $J^{(t)}_{llk}(\boldsymbol{\theta}) = -log \ y'^{(t)}_y$
> - $\odot$ : hadamard product



- derivative of $J^{(t)}$ with respect to $o^{(t)}_j$

  $if \quad y = j$

$$
\begin{align}
\frac{\partial J^{(t)}}{\partial o^{(t)}_j} &= \frac{\partial -log \ y'^{(t)}_y }{\partial o^{(t)}_j} \\\\
&= \frac{\partial -log\Big( \frac{exp(o^{(t)}_y)}{\sum_i exp(o^{(t)}_i)} \Big)}{\partial o^{(t)}_j} \\\\
&= \frac{\partial (-o^{(t)}_y + log \sum_i exp(o^{(t)}_i))}{\partial o^{(t)}_j} \\\\
&= -1 + \frac{exp(o^{(t)}_j)}{\sum_i exp(o^{(t)}_i)} \\\\
&= -1 + softmax(o^{(t)}_j)
\end{align}
$$

​		$if \quad y \ne j$
$$
\begin{align}
\frac{\partial J^{(t)}}{\partial o^{(t)}_j} &= \frac{\partial -log \ y'^{(t)}_y }{\partial o^{(t)}_j} \\\\
&= \frac{\partial -log\Big( \frac{exp(o^{(t)}_y)}{\sum_i exp(o^{(t)}_i)} \Big)}{\partial o^{(t)}_j} \\\\
&= \frac{\partial (-o^{(t)}_y + log \sum_i exp(o^{(t)}_i))}{\partial o^{(t)}_j} \\\\
&= 0 + \frac{exp(o^{(t)}_j)}{\sum_i exp(o^{(t)}_i)} \\\\
&= softmax(o^{(t)}_j)
\end{align}
$$


두 가지 경우를 하나로 합쳐서 나타내면 아래와 같다


$$
\begin{align}
\frac{\partial J^{(t)}}{\partial o^{(t)}_j} &= softmax(o^{(t)}_j) - y^{(t)}_j \\
&= y'^{(t)}_j - y^{(t)}_j
\end{align}
$$


- derivative of $J^{(t)}$ with respect to $\textbf V$


$$
\begin{align}
\frac{\partial J^{(t)}}{\partial \textbf V} &= \frac{\partial J^{(t)}}{\partial \textbf y^{(t)}} \times
											   \frac{\partial \textbf y^{(t)}}{\partial \textbf o^{(t)}} \times
											   \frac{\partial \textbf o^{(t)}}{\partial \textbf V} \\\\
&= \frac{\partial J^{(t)}}{\partial \textbf o^{(t)}} \times \textbf h^{(t)} \\\\
&= (\textbf y^{(t)} - \textbf y'^{(t)}) \odot \textbf h^{(t)}
\end{align}
$$


- derivative of $J^{(T)}$ with respect to $\textbf h^{(T)}$


$$
\begin{align}
\frac{\partial J^{(T)}}{\partial \textbf  h^{(T)}} &= \frac{\partial J^{(T)}}{\partial \textbf o^{(T)}} \times
													  \frac{\partial \textbf o^{(T)}}{\partial \textbf h^{(T)}}\\\\
&= \textbf V^T \times \frac{\partial J^{(T)}}{\partial \textbf o^{(T)}}
\end{align}
$$


- derivative of $J^{(\tilde{T})}$ with respect to $\textbf h^{(T-1)}$ 


$$
\begin{align}
\frac{\partial \Big( J^{(T - 1)} + J^{(T)} \Big)}{\partial \textbf h^{(T - 1)}} 
&= \frac{\partial J^{(T - 1)}}{\partial \textbf o^{(T - 1)}} \times
   \frac{\partial \textbf o^{(T - 1)}}{\partial \textbf h^{(T - 1)}} +
   \frac{\partial J^{T)}}{\partial \textbf h^{(T)}} \times 
   \frac{\partial \textbf h^{(T)}}{\partial \textbf a^{(T)}} \times
   \frac{\partial \textbf a^{(T)}}{\partial \textbf h^{(T-1)}} \\\\
&= \textbf V^T \times \frac{\partial J^{(T - 1)}}{\partial \textbf o^{(T - 1)}} +
\textbf W^T \times \frac{\partial J^{T)}}{\partial \textbf h^{(T)}} \odot tanh'(\textbf a^{(T)}) \\\\
&= \textbf V^T \times \frac{\partial J^{(T - 1)}}{\partial \textbf o^{(T - 1)}} +
\textbf W^T \times \frac{\partial J^{T)}}{\partial \textbf h^{(T)}} \times \textbf D(1 - (\textbf h^{(T)})^2)
\end{align}
$$
